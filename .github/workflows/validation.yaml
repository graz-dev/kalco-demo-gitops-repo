name: Kalco GitOps Validation

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'raw-resources/**'

jobs:
  validate-drift:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Kalco
        run: |
          # Install Kalco (latest release)
          curl -sL https://github.com/graz-dev/kalco/releases/latest/download/kalco_linux_amd64.tar.gz | tar xz
          sudo mv kalco /usr/local/bin/

      - name: Snapshot Live State
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG }}
          SNAPSHOT_TOKEN: ${{ secrets.SNAPSHOT_REPO_TOKEN }}
          SNAPSHOT_REPO: ${{ secrets.SNAPSHOT_REPO_URL }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > ~/.kube/config
          
          kalco config set snapshot-repo $SNAPSHOT_REPO
          kalco config set snapshot-token $SNAPSHOT_TOKEN
          
          # Create snapshot of the live 'guestbook' namespace
          kalco snapshot create --namespace guestbook --push

      - name: Detect Drifts
        id: kalco-diff
        run: |
          # Compare local manifests in PR with the live snapshot
          # We use the --local flag to point to the directory containing our manifests
          OUTPUT=$(kalco diff --local raw-resources/manifests --namespace guestbook)
          
          # Ensure output is properly escaped for multi-line string in GITHUB_OUTPUT
          echo "diff_output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Check for "DRIFT DETECTED" in the output
          if echo "$OUTPUT" | grep -q "DRIFT DETECTED"; then
            echo "has_drift=true" >> $GITHUB_OUTPUT
          else
            echo "has_drift=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR & Label
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = \`${{ steps.kalco-diff.outputs.diff_output }}\`;
            const hasDrift = ${{ steps.kalco-diff.outputs.has_drift }};
            
            const labelAdd = hasDrift ? 'kalco/deny' : 'kalco/approve';
            const labelRemove = hasDrift ? 'kalco/approve' : 'kalco/deny';
            
            // Add comment with diff output
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: \`### üõ°Ô∏è Kalco Validation Report\n\n\`\`\`\n\${output}\n\`\`\`\`
            });
            
            // Manage Labels
            try {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: labelRemove
              });
            } catch (e) {}
            
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: [labelAdd]
            });
            
            // Fail pipeline if dangerous drift is detected (optional)
            if (hasDrift) {
                core.setFailed('Drift detected! Potential conflict with live state.');
            }
