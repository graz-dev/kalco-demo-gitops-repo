name: Kalco GitOps Validation

on:
  pull_request:
    branches: [ master ]
    paths:
      - 'manifests/**'

jobs:
  validate-drift:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Needed for git diff

      - name: Install Kalco
        run: |
          curl -sL https://github.com/graz-dev/kalco/releases/latest/download/kalco_Linux_x86_64.tar.gz | tar xz
          sudo mv kalco /usr/local/bin/

      - name: Configure Kalco Context
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG }}
        run: |
          # Configure Git for Kalco's internal git operations
          git config --global user.email "ci-bot@kalco.dev"
          git config --global user.name "Kalco CI Bot"

          mkdir -p ~/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > ~/.kube/config
          
          # Create a temporary directory for the snapshot
          mkdir -p tmp-snapshot
          
          # Set context pointing to the temporary snapshot directory
          kalco context set validation-ctx \
            --kubeconfig ~/.kube/config \
            --output $(pwd)/tmp-snapshot \
            --description "CI Validation Context"

      - name: Snapshot Live State
        run: |
          # Export current cluster state to the temp directory
          # No git push needed as this is a transient snapshot for validation only
          kalco export

      - name: Detect Drifts
        id: kalco-diff
        run: |
          echo "Detecting changed files..."
          # Get list of changed YAML files in manifests/
          CHANGED_FILES=$(git diff --name-only origin/main -- manifests/ | grep '\.yaml$')
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No manifest changes detected."
            echo "has_drift=false" >> $GITHUB_OUTPUT
            echo "diff_output=No manifest changes." >> $GITHUB_OUTPUT
            exit 0
          fi

          TOTAL_DIFF=""
          HAS_DRIFT="false"

          for file in $CHANGED_FILES; do
            echo "Checking $file..."
            # diff command: --target <local-file> --snapshot-dir <temp-snapshot-dir>
            OUTPUT=$(kalco diff --target "$file" --snapshot-dir tmp-snapshot || true)
            
            if [ -n "$OUTPUT" ]; then
               TOTAL_DIFF+=$'\n'"File: $file"$'\n'"$OUTPUT"$'\n'
               if echo "$OUTPUT" | grep -q "DRIFT DETECTED"; then
                 HAS_DRIFT="true"
               fi
            fi
          done
          
          echo "has_drift=$HAS_DRIFT" >> $GITHUB_OUTPUT
          
          # Multiline output for comment
          echo "diff_output<<EOF" >> $GITHUB_OUTPUT
          echo "$TOTAL_DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR & Label
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = \`${{ steps.kalco-diff.outputs.diff_output }}\`;
            const hasDrift = ${{ steps.kalco-diff.outputs.has_drift }};
            
            if (output.trim() === "") return;

            const labelAdd = hasDrift ? 'kalco/deny' : 'kalco/approve';
            const labelRemove = hasDrift ? 'kalco/approve' : 'kalco/deny';
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: \`### üõ°Ô∏è Kalco Validation Report\n\n\`\`\`\n\${output}\n\`\`\`\`
            });
            
            try {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: labelRemove
              });
            } catch (e) {}
            
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: [labelAdd]
            });
